# asahi-ane-llm

Utilities that help convert and upload ONNX language models to the Asahi ANE
(Apple Neural Engine) driver. The helpers wrap the low level DRM ioctls that the
kernel exposes and make it easier to integrate model metadata, buffer
allocation, and submission logic in Python tooling.

## Installing

The package is published as a local helper inside this repository. You can
install it directly from the repository root using `pip` and the [`pyproject.toml`](pyproject.toml).

```bash
pip install -e libs/asahi_ane_llm
```

Optionally install the chat extras when you want to run the TinyLlama demo or
build your own text generation tooling:

```bash
pip install -e libs/asahi_ane_llm[chat]
```

Both commands install the package in editable mode so that local changes in the
repository are picked up immediately. If you publish the package to an index
such as PyPI you can omit `-e` and install directly from the uploaded wheel.

## Usage overview

The helper exposes three primary concepts:

1. `ANEDevice` handles the lifetime of the `/dev/dri/renderD*` file descriptor
   and provides convenience methods to allocate buffers managed by the driver.
2. `AneModelMetadata` parses the embedded `ane.*` metadata that the Asahi tools
   inject in ONNX models generated by the kernel builder pipeline.
3. `submit_onnx_model` uploads the ONNX payload, zeroes tile descriptors, and
   finally executes the `DRM_IOCTL_ANE_SUBMIT` call with the `ANE_SUBMIT_FLAG_ONNX`
   flag.

Refer to [`examples/onnx_submit.py`](../../examples/onnx_submit.py) for a minimal
script and [`examples/tinyllama_chat.py`](../../examples/tinyllama_chat.py) for a
conversational demo built on top of these primitives.

## Converting ONNX models for the ANE

Most upstream ONNX exports do not include the Asahi specific metadata fields
that bundle the compiled ANE microcode and tile descriptor information. Use the
conversion helper to attach these artefacts before uploading the model:

```bash
python3 tools/convert_to_ane.py \
    path/to/model.onnx \
    --bundle path/to/export/bundle.json
```

The helper expects metadata generated by the ANE toolchain. A bundle is a JSON
document containing base64 encoded microcode and (optionally) tile descriptors
and weights. When the tile descriptor payload is included the helper infers the
descriptor size and count automatically. Explicit values can be provided when
the compiler emitted them separately:

```bash
python3 tools/convert_to_ane.py \
    path/to/model.onnx \
    --microcode path/to/model.tsk \
    --tile-descriptors path/to/td.bin \
    --td-count 1024
```

The command derives the missing tile descriptor parameter whenever possible. If
`--tile-descriptors` is present the helper uses the payload length together with
`--td-size` or `--td-count` to infer the remaining value. Optional ANE weight
blobs can be embedded with `--weights`. The tool validates the output by
parsing it with `parse_ane_metadata` and writes the resulting `<model>_ane.onnx`
file next to the original payload unless an explicit `--output` path is
supplied.

### Auto-detecting compiler outputs

When the ANE toolchain emits multiple artefacts inside a build directory it can
be cumbersome to pass every path manually. Point `--artifact-root` at the
compiler output directory and the helper scans it recursively for likely
microcode (`*.tsk`, `*.microcode`), tile descriptor (`*tile_desc*.bin`,
`*.td.bin`) and weight payloads. Any item that is not specified explicitly via
`--microcode`, `--tile-descriptors`, or `--weights` is auto-filled from the
directory contents as long as the scan finds a single unambiguous match.

```bash
python3 tools/convert_to_ane.py \
    path/to/model.onnx \
    --artifact-root build/ane_export
```

The helper prints the artefacts it discovered before embedding them so you can
double-check the selection.

### Obtaining ANE microcode

The converter does **not** synthesize ANE microcode or tile descriptors. Those
payloads must be produced by the proprietary Apple toolchain or an equivalent
third-party compiler such as the reverse engineered work hosted in
[`eiln/ane`](https://github.com/eiln/ane). Clone and build the external
toolchain separately, then supply the generated `.tsk`, tile descriptor, and
optional weight blobs to the converter (either explicitly or through
`--artifact-root`). Without these artefacts the driver cannot execute the ONNX
model.
